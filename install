#!/bin/bash

mkdir -p thirdparty

# install z3
pushd thirdparty
wget https://github.com/Z3Prover/z3/archive/refs/tags/z3-4.13.0.tar.gz
tar xvfz z3-4.13.0.tar.gz
pushd z3-z3-4.13.0
python3 scripts/mk_make.py
pushd build
make -j 8
popd
z3path=`pwd`
echo ${z3path}
popd
popd
sz3path=${z3path//\//\\\/}
sed -i "s/Z3PATH/${sz3path}/g" src/CMakeLists.txt


# install cvc4
pushd thirdparty
wget https://github.com/CVC4/CVC4-archived/archive/refs/tags/1.8.tar.gz
tar xvfz 1.8.tar.gz
pushd CVC4-archived-1.8
./contrib/get-antlr-3.4
./configure.sh
mkdir build
pushd build
make -j 8
make check
make install
cvc4path=`pwd`
popd
popd
popd


# install gurobi
pushd thirdparty
wget https://packages.gurobi.com/9.1/gurobi9.1.2_linux64.tar.gz
tar xvfz gurobi9.1.2_linux64.tar.gz
pushd gurobi912/linux64
gurobipath=`pwd`
sgurobipath=${gurobipath//\//\\\/}
popd
popd
sed -i "s/GUROBIPATH/${sgurobipath}/g" src/CMakeLists.txt
# select the static library of gurobi
gcc_major_version=`echo __GNUC__ | gcc -E -xc - | tail -n 1`
gcc_minor_version=`echo __GNUC_MINOR__ | gcc -E -xc - | tail -n 1`
gcc_version=$gcc_major_version.$gcc_minor_version
if [ $gcc_version = 4.6 ] || [ $gcc_version = 4.8 ]
then
    sed -i "s/5.2.a/4.2.a/g" src/CMakeLists.txt
fi


# install AutoLifter
pushd thirdparty
git clone https://github.com/jiry17/AutoLifter.git
pushd AutoLifter 
./install 
popd
popd


# get Synduce
# export PATH="$HOME/.cabal/bin:$PATH"
echo export PATH=\"$HOME/.cabal/bin:\$PATH\" >> ~/.bashrc
echo export PATH=\"${z3path}/build:\$PATH\" >> ~/.bashrc
source ~/.bashrc
pushd thirdparty
git clone https://github.com/synduce/Synduce.git
pushd Synduce
make -j 8
popd
popd


# install ghcup
curl --proto '=https' --tlsv1.2 -sSf https://get-ghcup.haskell.org | sh
source ~/.bashrc
ghcup install ghc 9.2.5
ghcup set ghc 9.2.5


# get Grisette
cabal update
cabal install cabal-install
cabal install grisette
source ~/.bashrc


# make surface language
path=`pwd`
spath=${path//\//\\\/}
sed -i "s/SUFUPATH/\"${spath}\"/g" exp/python/config.py
pushd src/surface
make -j 8
popd


# build source
pushd src
path=`pwd`
spath=${path//\//\\\/}
sed -i "s/SOURCEPATH/\"${spath}\"/g" basic/config.cpp
popd

mkdir build
pushd build
cmake -G Ninja ../src
ninja
popd

